import{a as V}from"./chunk-MOMQEDRR.js";import{a as A}from"./chunk-6TD3QLD4.js";import{d as $}from"./chunk-H76PA2PH.js";import"./chunk-BYXBJQAS.js";import{a as H}from"./chunk-X4YI4MQ5.js";import"./chunk-NZYCSRIY.js";import{c as O,e as I}from"./chunk-NF2NXLZV.js";import"./chunk-3UOA546C.js";import{Ca as R,Db as N,Oa as C,Q as c,Ra as G,Sa as M,V as v,Va as k,W as h,Wa as S,X as x,Xa as f,Ya as l,Za as s,_a as m,a as _,b,db as E,ea as d,fb as p,hb as u,lb as F,mb as z,qb as y,ra as P,rb as D,sb as T,ta as w,ua as o,xb as L}from"./chunk-UNKFYFRK.js";var j=["canvas"],q=(n,i)=>i.id;function U(n,i){if(n&1){let e=E();l(0,"div",2)(1,"div",4),p("click",function(){let r=v(e).$implicit,a=u();return h(a.router.navigate([`/generator/${r.id}`]))}),m(2,"img",5)(3,"canvas",6,0),l(5,"div",7),y(6),s(),l(7,"div",8),p("click",function(r){let a=v(e).$implicit,g=u();return r.stopPropagation(),h(g.handleLike(a.id))}),l(8,"div"),y(9),s(),x(),l(10,"svg",9),m(11,"path",10),s()()()()}if(n&2){let e=i.$implicit,t=u();o(2),f("width",t.size)("height",t.size)("src",e.thumbnail,P),o(),f("width",t.size)("height",t.size),o(3),T("#",e.id),o(3),D(e.likes.length),o(2),C("fill",t.isLiked(e.likes)?"currentColor":"none")}}function Y(n,i){n&1&&(l(0,"div",3),m(1,"app-loader"),s())}var B=class n{route=c(O);router=c(I);fractal;userService=c(A);galleryService=c(H);currentPage=d(1);loading=d(!1);allRecords=d([]);totalRecords=d(0);canvasElements=N("canvas");galleryRecords=L(()=>this.allRecords());size=340;constructor(){this.fractal=new $}ngOnInit(){this.route.data.subscribe(i=>{let e=i.galleryFirstPage;if(e){this.allRecords.update(r=>[...r,...e.records]),this.totalRecords.set(e.pagination.total);let t=e.pagination.page*Math.round(e.pagination.limit/10);this.currentPage.set(t+1),setTimeout(()=>this.renderFractals(e.records,0))}})}onScroll(){let e=window.scrollY+window.innerHeight,t=document.body.scrollHeight;e>t-100&&this.loadNextPage()}loadNextPage(){let i=this.totalRecords();this.loading()||i&&this.allRecords().length>=i||(this.loading.set(!0),this.galleryService.get(this.currentPage()).subscribe({next:e=>{let t=this.allRecords().length;this.allRecords.update(r=>[...r,...e.records]),this.totalRecords.set(e.pagination.total),this.currentPage.update(r=>r+1),this.loading.set(!1),setTimeout(()=>this.renderFractals(e.records,t))},error:()=>{this.loading.set(!1)}}))}async renderFractals(i,e){let t=this.canvasElements();for(let r=0;r<i.length;r++){let a=i[r],g=t[e+r];g&&await this.renderFractalToCanvas(g.nativeElement,a.props)}}renderFractalToCanvas(i,e){return new Promise(t=>{requestAnimationFrame(()=>{let r=this.fractal.render(e,this.size,this.size),a=i.getContext("2d");a&&a.putImageData(r,0,0),t()})})}isLiked(i){let e=this.userService.user()?.id;return e&&i.includes(e)}handleLike(i){this.galleryService.like(i).subscribe({next:this.updateRecords})}updateRecords=i=>{this.allRecords.update(e=>e.map(t=>{if(t.id===i.id){let r=(t.version||0)+1;return b(_({},i),{version:r})}return t}))};static \u0275fac=function(e){return new(e||n)};static \u0275cmp=R({type:n,selectors:[["app-gallery"]],viewQuery:function(e,t){e&1&&F(t.canvasElements,j,5),e&2&&z()},hostBindings:function(e,t){e&1&&p("scroll",function(){return t.onScroll()},w)},decls:4,vars:1,consts:[["canvas",""],[1,"gallery-container"],[1,"item-container"],[1,"loading"],[1,"item",3,"click"],["alt","thumbnail",1,"thumbnail",3,"width","height","src"],[1,"canvas",3,"width","height"],[1,"index"],[1,"likes",3,"click"],["xmlns","http://www.w3.org/2000/svg","width","24","height","24","viewBox","0 0 24 24","stroke-width","2","stroke","currentColor"],["d","m12,22c-3.92-3.74-8.46-6.96-10.49-11.55C-1.22,3.94,7.65-1.13,12,4.29c4.35-5.41,13.22-.35,10.49,6.16-2.03,4.59-6.56,7.82-10.49,11.55Z"]],template:function(e,t){e&1&&(l(0,"div",1),k(1,U,12,8,"div",2,q),G(3,Y,2,0,"div",3),s()),e&2&&(o(),S(t.galleryRecords()),o(2),M(t.loading()?3:-1))},dependencies:[V],styles:["[_nghost-%COMP%]{width:100%}.gallery-container[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1rem;padding:1rem}.item-container[_ngcontent-%COMP%]{display:flex;justify-content:center}.item[_ngcontent-%COMP%]{position:relative;display:flex;border-radius:var(--border-radius);overflow:hidden}.thumbnail[_ngcontent-%COMP%]{position:absolute;top:0;left:0;filter:blur(5px);z-index:0}.canvas[_ngcontent-%COMP%]{z-index:1}.index[_ngcontent-%COMP%]{position:absolute;top:.5rem;left:.5rem;border-radius:var(--border-radius);background-color:#8888;line-height:1;padding:.25rem;z-index:2}.likes[_ngcontent-%COMP%]{position:absolute;bottom:.5rem;right:.5rem;border-radius:var(--border-radius);background-color:#8888;padding:.25rem;text-align:center;cursor:pointer;z-index:2}.loading[_ngcontent-%COMP%]{grid-column:1 / -1;text-align:center;padding:1rem}"]})};export{B as PageGallery};
